#!/bin/bash

######################################################################################################################################################
#
# Version   Date          Modified By       Description
# -------   ----          -----------       -----------
# v00.10    2018-02-18    Suresh Y Jayaram   HDFS Snapshots
#
######################################################################################################################################################

######################################################################################################################################################
# global variable list
######################################################################################################################################################


project_email_sender="suresh.y.jayaram.com"
project_email_failure="suresh.y.jayaram.com"

######################################################################################################################################################
# Function: To log messages to Log File
######################################################################################################################################################

write_log()
{
  if [[ "$#" == 0 ]]; then
    echo "" >>${run_log_file}
  else
    echo "${run_main_header} - `date '+%Y%m%d_%H%M%S'`: $*" >>${run_log_file}
  fi
}

######################################################################################################################################################
# Declaring environment/start variables
######################################################################################################################################################

TZ=US/Pacific

run_start_ts=`date "+%Y-%m-%d %H:%M:%S"`
run_start_ts_long=`echo ${run_start_ts} | sed "s/-/_/g;s/ /_/g;s/:/_/g"`

run_main_pid=$$
run_main_pid_num=`printf "%05d\n" ${run_main_pid}`

run_main_header=${run_start_ts_long}_${run_main_pid_num}


ENV_HOST_NAME=`hostname -f`



export DIR_LOG=
export DIR_CONF=


run_log_file=${DIR_LOG}/createSnapshot.log.`date '+%Y%m%d_%H%M%S'`

######################################################################################################################################################
# Allowing Snapshots
######################################################################################################################################################

while read allow_snap_location
do
hdfs dfsadmin -allowSnapshot ${allow_snap_location} >${DIR_LOG}/${allow_snap_location}.log

eturn_code=$?
echo $return_code
run_failed_desc="Failed for '${TBL_NAME}': allowSnapshot Error!!"

done <${DIR_CONF}/allowSnap.list

######################################################################################################################################################
# Creating Snapshots
######################################################################################################################################################


while read SNAP_LOC TBL_NAME
do
echo $SNAP_LOC $TBL_NAME
hdfs dfs -createSnapshot ${SNAP_LOC TBL_NAME} >${DIR_LOG}/${TBL_NAME}.log

return_code=$?
echo $return_code
run_failed_desc="Failed for '${TBL_NAME}': createSnapshot Error!!"

done <${DIR_CONF}/createSnap.list



write_log "#########################################################################################################################################"
write_log "END_TIME: `date "+%Y-%m-%d %H:%M:%S"`"
write_log "#########################################################################################################################################"

exit

########################################################End of Script################################################################################

